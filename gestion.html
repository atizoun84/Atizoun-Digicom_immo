<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartLocation ‚Äì Gestion & Proc√®s-verbaux</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#003366">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root { --navy: #003366; --gold: #ffcc00; --danger-red: #dc3545; --success-green: #198754; }
    body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-top: 140px; padding-bottom: 40px; }
    .navbar { background-color: var(--navy); z-index: 1050; border-bottom: 3px solid var(--gold); }
    .navbar-brand, .nav-link { color: white !important; }
    .navbar-date { color: var(--gold); font-weight: bold; font-size: 0.9rem; }
    
    .info-recuperee { color: #0099ff !important; font-weight: bold; background-color: #f8f9fa; }
    .option-paye { color: var(--success-green) !important; font-weight: bold; }
    /* Style pour les mois √©chus : Rouge et Gras */
    .option-retard { color: var(--danger-red) !important; font-weight: bold; background-color: #fff5f5; }
    
    .doc-container {
        border: 2px double var(--navy);
        padding: 40px;
        background: #fff;
        max-width: 850px;
        margin: auto;
        color: #000;
        line-height: 1.6;
    }
    
    #printArea { display: none; }
    
    @media print {
        body > *:not(#printArea) { display: none !important; }
        #printArea { display: block !important; position: absolute; top: 0; width: 100%; }
        .doc-container { border: 1px solid #000 !important; padding: 20px; }
        .no-print { display: none !important; }
    }

    .signature-img { max-width: 150px; max-height: 80px; object-fit: contain; margin-top: 10px; }
    .badge-retard { font-size: 1.1rem; padding: 10px; }
    
    /* Historique scrollable */
    #historiquePaiements { max-height: 300px; overflow-y: auto; }
  </style>
</head>
<body>

  <div id="printArea"></div>

  <nav class="navbar fixed-top navbar-expand-lg">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <img src="logo.png" alt="Logo" height="60" onerror="this.style.display='none'">
        <a class="navbar-brand fw-bold fs-3" href="#">SmartLoc <span id="navbarDate" class="navbar-date"></span></a>
      </div>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><span id="userNameDisplay" class="nav-link fw-bold text-warning"></span></li>
            <li class="nav-item"><a class="nav-link" href="index.html">Tableau de bord</a></li>
            <li class="nav-item"><button onclick="deconnexion()" class="btn btn-outline-danger btn-sm ms-2 text-white">D√©connexion</button></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container bg-white p-4 rounded shadow-sm">
    <h2 class="text-center mb-4" style="color:var(--navy)">üí≥ Gestion des Paiements & PV</h2>

    <div class="row g-3 mb-4">
      <div class="col-md-6">
        <label class="form-label fw-bold">üë§ Filtrer par Propri√©taire</label>
        <select id="selectProprietaire" class="form-select" onchange="chargerAppartements()"></select>
      </div>
      <div class="col-md-6">
        <label class="form-label fw-bold">üè¢ S√©lectionner l'Appartement / Locataire</label>
        <select id="selectAppartement" class="form-select" onchange="afficherDetails()"></select>
      </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <label class="form-label fw-bold">üìç Lieu du PV (M√©moris√©)</label>
            <input type="text" id="lieuPV" class="form-control" placeholder="Saisir le lieu..." onchange="sauvegarderLieu(this.value)">
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">üí∞ Loyer Mensuel (FCFA)</label>
            <input type="text" id="coutAffichage" class="form-control info-recuperee" readonly>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-bold">üö® √âtat des Impay√©s</label>
            <input type="text" id="retardAffichage" class="form-control fw-bold" readonly>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <label class="form-label fw-bold">üìÖ Historique & S√©lection des Mois</label>
            <p class="small text-muted">Les mois pass√©s non pay√©s s'affichent en <span class="text-danger fw-bold">Rouge Gras</span>.</p>
            <select id="selectMois" class="form-select" multiple size="12" onchange="calculerTotal()"></select>
        </div>
        <div class="col-md-6 d-flex flex-column justify-content-center">
            <div class="card p-3 border-primary shadow-sm">
                <h5 class="text-primary border-bottom pb-2">Actions de paiement</h5>
                
                <div id="sectionAvance" class="mb-3 p-2 bg-light border rounded">
                    <span class="small fw-bold">Solde des Avances :</span>
                    <span id="soldeAvanceDisplay" class="fw-bold text-primary">0 FCFA</span>
                </div>

                <label class="form-label mt-2">Total S√©lectionn√© :</label>
                <input type="text" id="totalPaiementDisplay" class="form-control fs-3 fw-bold text-success mb-3" value="0 FCFA" readonly>
                
                <div class="d-grid gap-2">
                    <button onclick="validerPaiement()" class="btn btn-success btn-lg">‚úÖ Enregistrer le Paiement</button>
                    <div class="row g-2">
                        <div class="col-6">
                            <button onclick="ajouterAvance()" class="btn btn-outline-primary w-100">‚ûï Ajouter Avance</button>
                        </div>
                        <div class="col-6">
                            <button onclick="utiliserAvance()" class="btn btn-outline-info w-100">‚öñÔ∏è Utiliser Avance</button>
                        </div>
                    </div>
                    <hr>
                    <button onclick="genererPV()" class="btn btn-primary">üìÑ G√©n√©rer PV d'Exercice</button>
                </div>
            </div>
            
            <div class="mt-4">
                <h6>Historique r√©cent</h6>
                <div id="historiquePaiements" class="list-group small"></div>
            </div>
        </div>
    </div>
  </div>

  <div class="modal fade" id="modalDoc" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-navy text-white">
            <h5 class="modal-title">Document Officiel - SmartLoc</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body bg-light" id="docContent"></div>
        <div class="modal-footer no-print">
          <button class="btn btn-dark" onclick="imprimerDoc()">üñ®Ô∏è Imprimer</button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const USER_INFO = { nom: "Atizoun Plateny AMOUSSOU", email: "atizoun@gmail.com", tel: "01 97 74 40 35" };
    let currentAptData = null;

    function initialiser() {
        document.getElementById('lieuPV').value = localStorage.getItem('smartloc_lieu_pv') || "";
        const session = JSON.parse(localStorage.getItem('smartloc_session'));
        if(session) document.getElementById('userNameDisplay').textContent = `${session.role.toUpperCase()} : ${session.nom}`;
        chargerProprietaire();
        chargerAppartements();
        mettreAJourDate();
    }

    function sauvegarderLieu(val) { localStorage.setItem('smartloc_lieu_pv', val); }

    function chargerProprietaire() {
        const props = JSON.parse(localStorage.getItem('smartloc_proprios')) || [];
        const sel = document.getElementById('selectProprietaire');
        sel.innerHTML = '<option value="">-- Tous les propri√©taires --</option>';
        props.forEach(p => sel.innerHTML += `<option value="${p.nom}">${p.nom}</option>`);
    }

    function chargerAppartements() {
        const apts = JSON.parse(localStorage.getItem('appartements')) || [];
        const filtre = document.getElementById('selectProprietaire').value;
        const sel = document.getElementById('selectAppartement');
        sel.innerHTML = '<option value="">-- Choisir un appartement --</option>';
        apts.forEach((a, i) => {
            if(!filtre || a.proprietaireNom === filtre) {
                sel.innerHTML += `<option value="${i}">${a.nom} - Locataire: ${a.locataire}</option>`;
            }
        });
    }

    function afficherDetails() {
        const idx = document.getElementById('selectAppartement').value;
        if(idx === "") return;
        const apts = JSON.parse(localStorage.getItem('appartements'));
        currentAptData = apts[idx];
        currentAptData.id = idx;
        document.getElementById('coutAffichage').value = parseInt(currentAptData.cout).toLocaleString() + " FCFA";
        analyserLoyerDynamique();
        chargerHistorique();
    }

    function analyserLoyerDynamique() {
        const selMois = document.getElementById('selectMois');
        selMois.innerHTML = "";
        const paiements = (JSON.parse(localStorage.getItem('paiements')) || {})[currentAptData.id] || [];
        const dateEntree = new Date(currentAptData.dateEntree || currentAptData.date);
        const dateAujourdhui = new Date();
        
        let curseur = new Date(dateEntree.getFullYear(), dateEntree.getMonth(), 1);
        let nbImpayes = 0;
        let totalDu = 0;
        
        // Calcul du solde des avances
        let soldeAvance = paiements.filter(p => p.type === 'Avance').reduce((acc, p) => acc + p.montant, 0);
        document.getElementById('soldeAvanceDisplay').textContent = soldeAvance.toLocaleString() + " FCFA";

        // De l'entr√©e jusqu'√† aujourd'hui + 1 mois
        const finBoucle = new Date(dateAujourdhui.getFullYear(), dateAujourdhui.getMonth() + 1, 1);

        while (curseur <= finBoucle) {
            const moisCle = curseur.toISOString().slice(0, 7);
            const label = curseur.toLocaleDateString('fr-FR', {month:'long', year:'numeric'}).toUpperCase();
            const estPaye = paiements.some(p => p.mois === moisCle && p.type === 'Paiement');
            const option = document.createElement('option');
            option.value = moisCle;

            if (estPaye) {
                option.textContent = `‚úÖ ${label} (PAY√â)`;
                option.className = "option-paye";
                option.disabled = true;
            } else {
                // Si le mois est strictement ant√©rieur au mois actuel -> ROUGE GRAS
                if (curseur < new Date(dateAujourdhui.getFullYear(), dateAujourdhui.getMonth(), 1)) {
                    option.textContent = `üö® ${label} (IMPAY√â)`;
                    option.className = "option-retard";
                    nbImpayes++;
                    totalDu += parseFloat(currentAptData.cout);
                } else {
                    option.textContent = `üìÖ ${label} (√Ä PAYER)`;
                }
            }
            selMois.appendChild(option);
            curseur.setMonth(curseur.getMonth() + 1);
        }
        document.getElementById('retardAffichage').value = nbImpayes > 0 ? `${nbImpayes} mois (${totalDu.toLocaleString()} FCFA)` : "√Ä jour ‚úÖ";
    }

    function calculerTotal() {
        const cout = parseFloat(currentAptData.cout);
        const selected = document.getElementById('selectMois').selectedOptions.length;
        document.getElementById('totalPaiementDisplay').value = (selected * cout).toLocaleString() + " FCFA";
    }

    function validerPaiement() {
        const selectedMois = Array.from(document.getElementById('selectMois').selectedOptions).filter(o => !o.disabled);
        if(selectedMois.length === 0) return alert("S√©lectionnez des mois impay√©s.");
        
        enregistrerOperation(selectedMois.map(opt => ({
            mois: opt.value,
            montant: parseFloat(currentAptData.cout),
            type: 'Paiement'
        })));
        alert("Paiements enregistr√©s.");
        afficherDetails();
    }

    function ajouterAvance() {
        const mnt = prompt("Montant de l'avance (FCFA) :");
        if(!mnt || isNaN(mnt)) return;
        enregistrerOperation([{
            mois: new Date().toISOString().slice(0, 7),
            montant: parseFloat(mnt),
            type: 'Avance'
        }]);
        alert("Avance cr√©dit√©e.");
        afficherDetails();
    }

    function utiliserAvance() {
        const selectedMois = Array.from(document.getElementById('selectMois').selectedOptions).filter(o => !o.disabled);
        if(selectedMois.length === 0) return alert("S√©lectionnez les mois √† couvrir par l'avance.");
        
        const coutTotal = selectedMois.length * parseFloat(currentAptData.cout);
        const paiements = (JSON.parse(localStorage.getItem('paiements')) || {})[currentAptData.id] || [];
        const solde = paiements.filter(p => p.type === 'Avance').reduce((acc, p) => acc + p.montant, 0);

        if(solde < coutTotal) return alert(`Solde insuffisant (${solde} FCFA) pour payer ${coutTotal} FCFA.`);

        // On d√©duit des avances (montant n√©gatif) et on cr√©e les lignes de paiement
        let ops = selectedMois.map(opt => ({ mois: opt.value, montant: parseFloat(currentAptData.cout), type: 'Paiement' }));
        ops.push({ mois: new Date().toISOString().slice(0, 7), montant: -coutTotal, type: 'Avance', obs: 'D√©duction pour paiement loyer' });
        
        enregistrerOperation(ops);
        alert("Loyer r√©gl√© via le solde des avances.");
        afficherDetails();
    }

    function enregistrerOperation(operations) {
        let allP = JSON.parse(localStorage.getItem('paiements')) || {};
        if(!allP[currentAptData.id]) allP[currentAptData.id] = [];
        
        operations.forEach(op => {
            allP[currentAptData.id].push({
                id: Date.now() + Math.random(),
                mois: op.mois,
                montant: op.montant,
                type: op.type,
                observation: op.obs || "",
                dateEnregistrement: new Date().toISOString()
            });
        });
        localStorage.setItem('paiements', JSON.stringify(allP));
    }

    function chargerHistorique() {
        const histDiv = document.getElementById('historiquePaiements');
        histDiv.innerHTML = "";
        const paiements = ((JSON.parse(localStorage.getItem('paiements')) || {})[currentAptData.id] || []).slice(-10).reverse();
        
        paiements.forEach(p => {
            const item = document.createElement('div');
            item.className = "list-group-item d-flex justify-content-between align-items-center";
            item.innerHTML = `
                <div>
                    <span class="fw-bold">${p.type}</span> - ${p.montant.toLocaleString()} F<br>
                    <small class="text-muted">${p.mois} (${new Date(p.dateEnregistrement).toLocaleDateString()})</small>
                </div>
                <button onclick="supprimerOperation(${p.id})" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
            `;
            histDiv.appendChild(item);
        });
    }

    function supprimerOperation(id) {
        if(!confirm("Supprimer cette op√©ration ?")) return;
        let allP = JSON.parse(localStorage.getItem('paiements'));
        allP[currentAptData.id] = allP[currentAptData.id].filter(p => p.id !== id);
        localStorage.setItem('paiements', JSON.stringify(allP));
        afficherDetails();
    }

    function genererPV() {
        const lieu = document.getElementById('lieuPV').value;
        if(!lieu) return alert("Saisissez le lieu.");
        const dateNow = new Date();
        const html = `
            <div class="doc-container shadow">
                <p><b>Fait √† ${lieu.toUpperCase()}</b></p>
                <p>L'an deux mil sept et le ${dateNow.toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})},</p>
                <p>Nous soussign√©, <b>${USER_INFO.nom}</b>, certifions que le locataire <b>${currentAptData.locataire.toUpperCase()}</b> s'est acquitt√© de ses obligations pour l'appartement <b>${currentAptData.nom}</b>.</p>
                <div class="row mt-5">
                    <div class="col-6 text-center"><u>Le Locataire</u></div>
                    <div class="col-6 text-center"><u>Le Bailleur</u><br><b>${USER_INFO.nom}</b></div>
                </div>
            </div>
        `;
        document.getElementById('docContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalDoc')).show();
    }

    function imprimerDoc() {
        document.getElementById('printArea').innerHTML = document.getElementById('docContent').innerHTML;
        window.print();
    }

    function mettreAJourDate() {
        document.getElementById('navbarDate').textContent = "| " + new Date().toLocaleDateString('fr-FR', {day:'numeric', month:'long', year:'numeric'});
    }

    function deconnexion() { localStorage.removeItem('smartloc_session'); window.location.href = 'login.html'; }

    window.onload = initialiser;
  </script>
</body>
</html>
